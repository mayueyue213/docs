<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Babel</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" type="image/png" sizes="32x32" href="/docs/images/mayueyue-32.png">
    <meta name="description" content="前端框架学习笔记">
    <meta name="keywords" content="前端框架学习笔记">
    
    <link rel="preload" href="/docs/assets/css/0.styles.db1112bd.css" as="style"><link rel="preload" href="/docs/assets/js/app.a2920d1a.js" as="script"><link rel="preload" href="/docs/assets/js/3.2c08a1e7.js" as="script"><link rel="preload" href="/docs/assets/js/47.2ab3c263.js" as="script"><link rel="prefetch" href="/docs/assets/js/10.8d48b436.js"><link rel="prefetch" href="/docs/assets/js/100.f1639904.js"><link rel="prefetch" href="/docs/assets/js/101.5582cf09.js"><link rel="prefetch" href="/docs/assets/js/102.f43939c6.js"><link rel="prefetch" href="/docs/assets/js/103.d6c1e324.js"><link rel="prefetch" href="/docs/assets/js/104.dbe24320.js"><link rel="prefetch" href="/docs/assets/js/105.c13810d4.js"><link rel="prefetch" href="/docs/assets/js/106.80299f2a.js"><link rel="prefetch" href="/docs/assets/js/107.d6a48820.js"><link rel="prefetch" href="/docs/assets/js/108.d3e3c6d9.js"><link rel="prefetch" href="/docs/assets/js/109.bb94d128.js"><link rel="prefetch" href="/docs/assets/js/11.8bd9782b.js"><link rel="prefetch" href="/docs/assets/js/110.ee945cd4.js"><link rel="prefetch" href="/docs/assets/js/111.5f7604f5.js"><link rel="prefetch" href="/docs/assets/js/112.eda7bc2a.js"><link rel="prefetch" href="/docs/assets/js/113.c3ea0635.js"><link rel="prefetch" href="/docs/assets/js/114.fdaf3805.js"><link rel="prefetch" href="/docs/assets/js/115.61d96bb4.js"><link rel="prefetch" href="/docs/assets/js/116.7dbcad57.js"><link rel="prefetch" href="/docs/assets/js/117.9fb2e5d8.js"><link rel="prefetch" href="/docs/assets/js/118.a3e9cddf.js"><link rel="prefetch" href="/docs/assets/js/119.63d19efb.js"><link rel="prefetch" href="/docs/assets/js/12.19d7956d.js"><link rel="prefetch" href="/docs/assets/js/120.f5e0b945.js"><link rel="prefetch" href="/docs/assets/js/121.340da1e2.js"><link rel="prefetch" href="/docs/assets/js/122.4b75afbe.js"><link rel="prefetch" href="/docs/assets/js/123.b30b55a0.js"><link rel="prefetch" href="/docs/assets/js/124.bce508b6.js"><link rel="prefetch" href="/docs/assets/js/125.317ced0f.js"><link rel="prefetch" href="/docs/assets/js/126.2320ac7e.js"><link rel="prefetch" href="/docs/assets/js/127.150e581a.js"><link rel="prefetch" href="/docs/assets/js/128.59763692.js"><link rel="prefetch" href="/docs/assets/js/129.4f1b1448.js"><link rel="prefetch" href="/docs/assets/js/13.8117402d.js"><link rel="prefetch" href="/docs/assets/js/130.25f9146f.js"><link rel="prefetch" href="/docs/assets/js/131.6254a3c8.js"><link rel="prefetch" href="/docs/assets/js/132.9780a231.js"><link rel="prefetch" href="/docs/assets/js/133.a1c6f255.js"><link rel="prefetch" href="/docs/assets/js/134.0ada5330.js"><link rel="prefetch" href="/docs/assets/js/135.814fada4.js"><link rel="prefetch" href="/docs/assets/js/136.8310e5c0.js"><link rel="prefetch" href="/docs/assets/js/137.a28bd3d2.js"><link rel="prefetch" href="/docs/assets/js/138.d3a58b9b.js"><link rel="prefetch" href="/docs/assets/js/139.ce7b069e.js"><link rel="prefetch" href="/docs/assets/js/14.b16e20b9.js"><link rel="prefetch" href="/docs/assets/js/140.b6d1b35e.js"><link rel="prefetch" href="/docs/assets/js/141.9a24e267.js"><link rel="prefetch" href="/docs/assets/js/142.b35fa891.js"><link rel="prefetch" href="/docs/assets/js/143.6f747e24.js"><link rel="prefetch" href="/docs/assets/js/144.0e2de477.js"><link rel="prefetch" href="/docs/assets/js/145.c3320afb.js"><link rel="prefetch" href="/docs/assets/js/146.0cd89fc2.js"><link rel="prefetch" href="/docs/assets/js/147.8779cd5a.js"><link rel="prefetch" href="/docs/assets/js/148.02797559.js"><link rel="prefetch" href="/docs/assets/js/149.960d5bbc.js"><link rel="prefetch" href="/docs/assets/js/15.6cfb993c.js"><link rel="prefetch" href="/docs/assets/js/150.9bce4450.js"><link rel="prefetch" href="/docs/assets/js/16.216bbea9.js"><link rel="prefetch" href="/docs/assets/js/17.d1747467.js"><link rel="prefetch" href="/docs/assets/js/18.9fb89893.js"><link rel="prefetch" href="/docs/assets/js/19.e1463f50.js"><link rel="prefetch" href="/docs/assets/js/20.8fb6e451.js"><link rel="prefetch" href="/docs/assets/js/21.011555e9.js"><link rel="prefetch" href="/docs/assets/js/22.65499417.js"><link rel="prefetch" href="/docs/assets/js/23.60844ae4.js"><link rel="prefetch" href="/docs/assets/js/24.93f3daca.js"><link rel="prefetch" href="/docs/assets/js/25.ce7c13d8.js"><link rel="prefetch" href="/docs/assets/js/26.5b005337.js"><link rel="prefetch" href="/docs/assets/js/27.fda08a27.js"><link rel="prefetch" href="/docs/assets/js/28.45928969.js"><link rel="prefetch" href="/docs/assets/js/29.25ba646f.js"><link rel="prefetch" href="/docs/assets/js/30.d9ca340d.js"><link rel="prefetch" href="/docs/assets/js/31.99e723cf.js"><link rel="prefetch" href="/docs/assets/js/32.35c0e407.js"><link rel="prefetch" href="/docs/assets/js/33.9354631a.js"><link rel="prefetch" href="/docs/assets/js/34.8a4520b5.js"><link rel="prefetch" href="/docs/assets/js/35.cc264763.js"><link rel="prefetch" href="/docs/assets/js/36.540b4370.js"><link rel="prefetch" href="/docs/assets/js/37.1dffdea9.js"><link rel="prefetch" href="/docs/assets/js/38.30819fa7.js"><link rel="prefetch" href="/docs/assets/js/39.33da4a8a.js"><link rel="prefetch" href="/docs/assets/js/4.08956514.js"><link rel="prefetch" href="/docs/assets/js/40.2c1f6168.js"><link rel="prefetch" href="/docs/assets/js/41.38f2a64c.js"><link rel="prefetch" href="/docs/assets/js/42.73f0c51a.js"><link rel="prefetch" href="/docs/assets/js/43.c13b1570.js"><link rel="prefetch" href="/docs/assets/js/44.2a702d17.js"><link rel="prefetch" href="/docs/assets/js/45.29fce076.js"><link rel="prefetch" href="/docs/assets/js/46.142e4d45.js"><link rel="prefetch" href="/docs/assets/js/48.b6814490.js"><link rel="prefetch" href="/docs/assets/js/49.b8e16aa4.js"><link rel="prefetch" href="/docs/assets/js/5.01b6ed83.js"><link rel="prefetch" href="/docs/assets/js/50.aa9637e9.js"><link rel="prefetch" href="/docs/assets/js/51.1b73d6a7.js"><link rel="prefetch" href="/docs/assets/js/52.9d33ff6f.js"><link rel="prefetch" href="/docs/assets/js/53.534396ee.js"><link rel="prefetch" href="/docs/assets/js/54.aabc79a9.js"><link rel="prefetch" href="/docs/assets/js/55.85a552f5.js"><link rel="prefetch" href="/docs/assets/js/56.f90e7a4c.js"><link rel="prefetch" href="/docs/assets/js/57.fe4e4c38.js"><link rel="prefetch" href="/docs/assets/js/58.d3ad9d7c.js"><link rel="prefetch" href="/docs/assets/js/59.cec9dc11.js"><link rel="prefetch" href="/docs/assets/js/6.4f022779.js"><link rel="prefetch" href="/docs/assets/js/60.759e1cfd.js"><link rel="prefetch" href="/docs/assets/js/61.b5347b5a.js"><link rel="prefetch" href="/docs/assets/js/62.070e2bb9.js"><link rel="prefetch" href="/docs/assets/js/63.89e25b8c.js"><link rel="prefetch" href="/docs/assets/js/64.78ea45bf.js"><link rel="prefetch" href="/docs/assets/js/65.76d77ddf.js"><link rel="prefetch" href="/docs/assets/js/66.c3168e3c.js"><link rel="prefetch" href="/docs/assets/js/67.7a38209a.js"><link rel="prefetch" href="/docs/assets/js/68.4029c892.js"><link rel="prefetch" href="/docs/assets/js/69.b16f9af0.js"><link rel="prefetch" href="/docs/assets/js/7.7e83f2ae.js"><link rel="prefetch" href="/docs/assets/js/70.ffce3561.js"><link rel="prefetch" href="/docs/assets/js/71.302e1240.js"><link rel="prefetch" href="/docs/assets/js/72.9472a7ed.js"><link rel="prefetch" href="/docs/assets/js/73.034b79f0.js"><link rel="prefetch" href="/docs/assets/js/74.32ba64d6.js"><link rel="prefetch" href="/docs/assets/js/75.70dad71d.js"><link rel="prefetch" href="/docs/assets/js/76.b47506c9.js"><link rel="prefetch" href="/docs/assets/js/77.ff7b7c9f.js"><link rel="prefetch" href="/docs/assets/js/78.bdcd739f.js"><link rel="prefetch" href="/docs/assets/js/79.6b27b699.js"><link rel="prefetch" href="/docs/assets/js/8.634ce17e.js"><link rel="prefetch" href="/docs/assets/js/80.699c85a6.js"><link rel="prefetch" href="/docs/assets/js/81.f00264c7.js"><link rel="prefetch" href="/docs/assets/js/82.48a41ec1.js"><link rel="prefetch" href="/docs/assets/js/83.bae24a9b.js"><link rel="prefetch" href="/docs/assets/js/84.2f41be2d.js"><link rel="prefetch" href="/docs/assets/js/85.e57ca5c1.js"><link rel="prefetch" href="/docs/assets/js/86.20a19123.js"><link rel="prefetch" href="/docs/assets/js/87.fd0cc782.js"><link rel="prefetch" href="/docs/assets/js/88.41280039.js"><link rel="prefetch" href="/docs/assets/js/89.f17f43df.js"><link rel="prefetch" href="/docs/assets/js/9.4626406b.js"><link rel="prefetch" href="/docs/assets/js/90.376a4991.js"><link rel="prefetch" href="/docs/assets/js/91.01c8dd95.js"><link rel="prefetch" href="/docs/assets/js/92.7e0a6901.js"><link rel="prefetch" href="/docs/assets/js/93.5f623d8f.js"><link rel="prefetch" href="/docs/assets/js/94.42411128.js"><link rel="prefetch" href="/docs/assets/js/95.f7820d21.js"><link rel="prefetch" href="/docs/assets/js/96.e93033c5.js"><link rel="prefetch" href="/docs/assets/js/97.35e61fd4.js"><link rel="prefetch" href="/docs/assets/js/98.f3490b34.js"><link rel="prefetch" href="/docs/assets/js/99.776d79e5.js"><link rel="prefetch" href="/docs/assets/js/vendors~photo-swipe.c7363f24.js">
    <link rel="stylesheet" href="/docs/assets/css/0.styles.db1112bd.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/docs/" class="home-link router-link-active"><img src="/docs/images/mayueyue.png" alt="" class="logo"> <!----></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/docs/vue/v2/overview/" class="nav-link">
  Vue 2
</a></div><div class="nav-item"><a href="/docs/manual/" class="nav-link router-link-active">
  知识手册
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/docs/vue/v2/overview/" class="nav-link">
  Vue 2
</a></div><div class="nav-item"><a href="/docs/manual/" class="nav-link router-link-active">
  知识手册
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>JavaScript</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/docs/manual/javascript/" class="sidebar-link">知识概要</a></li><li><a href="/docs/manual/javascript/ctx.html" class="sidebar-link">执行上下文</a></li><li><a href="/docs/manual/javascript/scope.html" class="sidebar-link">作用域</a></li><li><a href="/docs/manual/javascript/closure.html" class="sidebar-link">闭包</a></li><li><a href="/docs/manual/javascript/this.html" class="sidebar-link">this</a></li><li><a href="/docs/manual/javascript/promise.html" class="sidebar-link">Promise</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>浏览器</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/docs/manual/browser/process.html" class="sidebar-link">多进程架构</a></li><li><a href="/docs/manual/browser/render.html" class="sidebar-link">渲染流程</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>前后端框架</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/docs/manual/framework/express.html" class="sidebar-link">Express</a></li><li><a href="/docs/manual/framework/koa.html" class="sidebar-link">Koa</a></li><li><a href="/docs/manual/framework/egg.html" class="sidebar-link">Egg</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>前端工程化</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/docs/manual/engineering/" aria-current="page" class="sidebar-link">工程化</a></li><li><a href="/docs/manual/engineering/babel.html" aria-current="page" class="active sidebar-link">Babel</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/manual/engineering/babel.html#babel-2" class="sidebar-link">babel</a></li><li class="sidebar-sub-header"><a href="/docs/manual/engineering/babel.html#parse" class="sidebar-link">parse</a></li><li class="sidebar-sub-header"><a href="/docs/manual/engineering/babel.html#transform" class="sidebar-link">transform</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/manual/engineering/babel.html#traverse" class="sidebar-link">traverse</a></li><li class="sidebar-sub-header"><a href="/docs/manual/engineering/babel.html#visitor" class="sidebar-link">visitor</a></li><li class="sidebar-sub-header"><a href="/docs/manual/engineering/babel.html#path" class="sidebar-link">path</a></li><li class="sidebar-sub-header"><a href="/docs/manual/engineering/babel.html#对比" class="sidebar-link">对比</a></li><li class="sidebar-sub-header"><a href="/docs/manual/engineering/babel.html#小结" class="sidebar-link">小结</a></li></ul></li><li class="sidebar-sub-header"><a href="/docs/manual/engineering/babel.html#generate" class="sidebar-link">generate</a></li><li class="sidebar-sub-header"><a href="/docs/manual/engineering/babel.html#plugin" class="sidebar-link">plugin</a></li><li class="sidebar-sub-header"><a href="/docs/manual/engineering/babel.html#preset" class="sidebar-link">preset</a></li><li class="sidebar-sub-header"><a href="/docs/manual/engineering/babel.html#总结" class="sidebar-link">总结</a></li></ul></li><li><a href="/docs/manual/engineering/wp.html" class="sidebar-link">Webpack</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>网络</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/docs/manual/networking/" class="sidebar-link">知识概要</a></li><li><a href="/docs/manual/networking/http.html" class="sidebar-link">HTTP</a></li><li><a href="/docs/manual/networking/cache.html" class="sidebar-link">HTTP 缓存</a></li><li><a href="/docs/manual/networking/dhcp.html" class="sidebar-link">DHCP</a></li><li><a href="/docs/manual/networking/icmp.html" class="sidebar-link">ICMP</a></li><li><a href="/docs/manual/networking/tcp.html" class="sidebar-link">TCP</a></li></ul></section></li><li><a href="/docs/manual/perfomance/" class="sidebar-link">性能优化</a></li><li><a href="/docs/manual/security/" class="sidebar-link">Web 安全</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="babel"><a href="#babel" class="header-anchor">#</a> Babel</h1> <p><strong>Babel is a JavaScript compiler</strong>，既然是 <strong>compiler</strong>，过程基本上就是 <code>parse</code>(生成AST)，<code>optimize</code>(AST优化)和<code>generate</code>(代码生成)三个过程。</p> <table><thead><tr><th>名称</th> <th>版本</th></tr></thead> <tbody><tr><td>Bable</td> <td>7.x</td></tr></tbody></table> <h2 id="babel-2"><a href="#babel-2" class="header-anchor">#</a> babel</h2> <p><code>babel</code>命令定义在<code>@babel/cli</code>包中，即<code>babel/packages/babel-cli/src/index.js</code></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>#<span class="token operator">!</span><span class="token operator">/</span>usr<span class="token operator">/</span>bin<span class="token operator">/</span>env node

<span class="token keyword">import</span> parseArgv <span class="token keyword">from</span> <span class="token string">&quot;./options&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> dirCommand <span class="token keyword">from</span> <span class="token string">&quot;./dir&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> fileCommand <span class="token keyword">from</span> <span class="token string">&quot;./file&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> opts <span class="token operator">=</span> <span class="token function">parseArgv</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>argv<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>opts<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> fn <span class="token operator">=</span> opts<span class="token punctuation">.</span>cliOptions<span class="token punctuation">.</span>outDir <span class="token operator">?</span> dirCommand <span class="token operator">:</span> fileCommand<span class="token punctuation">;</span>
  <span class="token function">fn</span><span class="token punctuation">(</span>opts<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
    process<span class="token punctuation">.</span>exitCode <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  process<span class="token punctuation">.</span>exitCode <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p><code>opts</code>是用<code>commander</code>进行参数转换，这是<code>CLI</code>工具基本套路。这段代码的逻辑非常简单，就是根据是针对<code>file</code>还是<code>dir</code>来执行不同的命令，继续往深层稍微查找一下，可以得到这个结论 —— 对于<code>dir</code>找到每个文件执行<code>babel.transformFile</code>，对于<code>file</code>执行<code>babel.transform</code>。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>babel<span class="token punctuation">.</span><span class="token function">transformFile</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> options<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
babel<span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> options<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>这俩函数，最核心的逻辑是一样的，研究一个即可，这里选择<code>transformFile</code>。<code>transformFile</code>定义在<code>babel/packages/babel-core/src/transform-file.ts</code>文件</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">const</span> transformFileRunner <span class="token operator">=</span> gensync<span class="token operator">&lt;</span>
  <span class="token punctuation">(</span>filename<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> opts<span class="token operator">?</span><span class="token operator">:</span> InputOptions<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> FileResult <span class="token operator">|</span> <span class="token keyword">null</span>
<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token operator">*</span> <span class="token punctuation">(</span>filename<span class="token punctuation">,</span> opts<span class="token operator">:</span> InputOptions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token operator">...</span>opts<span class="token punctuation">,</span> filename <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> config<span class="token operator">:</span> ResolvedConfig <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token operator">=</span> <span class="token keyword">yield</span><span class="token operator">*</span> <span class="token function">loadConfig</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>config <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> code <span class="token operator">=</span> <span class="token keyword">yield</span><span class="token operator">*</span> fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> <span class="token string">&quot;utf8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">yield</span><span class="token operator">*</span> <span class="token function">run</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> code<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> transformFile <span class="token operator">=</span> transformFileRunner<span class="token punctuation">.</span>errback <span class="token keyword">as</span> TransformFile<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p><code>run</code>函数如下</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">run</span><span class="token punctuation">(</span>
  config<span class="token operator">:</span> ResolvedConfig<span class="token punctuation">,</span>
  code<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
  ast<span class="token operator">?</span><span class="token operator">:</span> t<span class="token punctuation">.</span>File <span class="token operator">|</span> t<span class="token punctuation">.</span>Program <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token operator">:</span> Handler<span class="token operator">&lt;</span>FileResult<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> file <span class="token operator">=</span> <span class="token keyword">yield</span><span class="token operator">*</span> <span class="token function">normalizeFile</span><span class="token punctuation">(</span>
    config<span class="token punctuation">.</span>passes<span class="token punctuation">,</span>
    <span class="token function">normalizeOptions</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">,</span>
    code<span class="token punctuation">,</span>
    ast<span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> opts <span class="token operator">=</span> file<span class="token punctuation">.</span>opts<span class="token punctuation">;</span>
  <span class="token keyword">yield</span><span class="token operator">*</span> <span class="token function">transformFile</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> config<span class="token punctuation">.</span>passes<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">let</span> outputCode<span class="token punctuation">,</span> outputMap<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>opts<span class="token punctuation">.</span>code <span class="token operator">!==</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">(</span><span class="token punctuation">{</span> outputCode<span class="token punctuation">,</span> outputMap <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">generateCode</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>passes<span class="token punctuation">,</span> file<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// ...</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    metadata<span class="token operator">:</span> file<span class="token punctuation">.</span>metadata<span class="token punctuation">,</span>
    options<span class="token operator">:</span> opts<span class="token punctuation">,</span>
    ast<span class="token operator">:</span> opts<span class="token punctuation">.</span>ast <span class="token operator">===</span> <span class="token boolean">true</span> <span class="token operator">?</span> file<span class="token punctuation">.</span>ast <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    code<span class="token operator">:</span> outputCode <span class="token operator">===</span> <span class="token keyword">undefined</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> outputCode<span class="token punctuation">,</span>
    map<span class="token operator">:</span> outputMap <span class="token operator">===</span> <span class="token keyword">undefined</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> outputMap<span class="token punctuation">,</span>
    sourceType<span class="token operator">:</span> file<span class="token punctuation">.</span>ast<span class="token punctuation">.</span>program<span class="token punctuation">.</span>sourceType<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><p>这里的<code>normalizeFile</code>，<code>transformFile</code>和<code>generateCode</code>就分别对应了编译的三个步骤 —— 解析，转换和代码生成。</p> <h2 id="parse"><a href="#parse" class="header-anchor">#</a> parse</h2> <p>解析过程，就是对源码根据一定的规则去分析生成<code>AST</code>。在前面所述<code>run</code>函数中，解析生成AST的代码如下</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> file <span class="token operator">=</span> <span class="token keyword">yield</span><span class="token operator">*</span> <span class="token function">normalizeFile</span><span class="token punctuation">(</span>
  config<span class="token punctuation">.</span>passes<span class="token punctuation">,</span>
  <span class="token function">normalizeOptions</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">,</span>
  code<span class="token punctuation">,</span>
  ast<span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>使用如下示例说明</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> code <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">setTimeout(() =&gt; {
  console.log('welcome')
}, 3000)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;@babel/core&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">transformAsync</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>解析得到的<code>ast</code>结果如下</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> ast <span class="token operator">=</span> <span class="token punctuation">{</span>
  type<span class="token operator">:</span> <span class="token string">&quot;File&quot;</span><span class="token punctuation">,</span>
  start<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  end<span class="token operator">:</span> <span class="token number">52</span><span class="token punctuation">,</span>
  loc<span class="token operator">:</span> <span class="token punctuation">{</span> start<span class="token operator">:</span> <span class="token punctuation">{</span> line<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> column<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> end<span class="token operator">:</span> <span class="token punctuation">{</span> line<span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span> column<span class="token operator">:</span> <span class="token number">8</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  errors<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  program<span class="token operator">:</span> <span class="token punctuation">{</span>
    type<span class="token operator">:</span> <span class="token string">&quot;Program&quot;</span><span class="token punctuation">,</span>
    start<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    end<span class="token operator">:</span> <span class="token number">52</span><span class="token punctuation">,</span>
    loc<span class="token operator">:</span> <span class="token punctuation">{</span> start<span class="token operator">:</span> <span class="token punctuation">{</span> line<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> column<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> end<span class="token operator">:</span> <span class="token punctuation">{</span> line<span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span> column<span class="token operator">:</span> <span class="token number">8</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    sourceType<span class="token operator">:</span> <span class="token string">&quot;module&quot;</span><span class="token punctuation">,</span>
    interpreter<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    body<span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        type<span class="token operator">:</span> <span class="token string">&quot;ExpressionStatement&quot;</span><span class="token punctuation">,</span>
        start<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        end<span class="token operator">:</span> <span class="token number">52</span><span class="token punctuation">,</span>
        loc<span class="token operator">:</span> <span class="token punctuation">{</span> start<span class="token operator">:</span> <span class="token punctuation">{</span> line<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> column<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> end<span class="token operator">:</span> <span class="token punctuation">{</span> line<span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span> column<span class="token operator">:</span> <span class="token number">8</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        expression<span class="token operator">:</span> <span class="token punctuation">{</span>
          type<span class="token operator">:</span> <span class="token string">&quot;CallExpression&quot;</span><span class="token punctuation">,</span>
          start<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
          end<span class="token operator">:</span> <span class="token number">52</span><span class="token punctuation">,</span>
          loc<span class="token operator">:</span> <span class="token punctuation">{</span> start<span class="token operator">:</span> <span class="token punctuation">{</span> line<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> column<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> end<span class="token operator">:</span> <span class="token punctuation">{</span> line<span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span> column<span class="token operator">:</span> <span class="token number">8</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
          callee<span class="token operator">:</span> <span class="token punctuation">{</span>
            type<span class="token operator">:</span> <span class="token string">&quot;Identifier&quot;</span><span class="token punctuation">,</span>
            start<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
            end<span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
            loc<span class="token operator">:</span> <span class="token punctuation">{</span>
              start<span class="token operator">:</span> <span class="token punctuation">{</span> line<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> column<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
              end<span class="token operator">:</span> <span class="token punctuation">{</span> line<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> column<span class="token operator">:</span> <span class="token number">10</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
              identifierName<span class="token operator">:</span> <span class="token string">&quot;setTimeout&quot;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            name<span class="token operator">:</span> <span class="token string">&quot;setTimeout&quot;</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          arguments<span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{</span>
              type<span class="token operator">:</span> <span class="token string">&quot;ArrowFunctionExpression&quot;</span><span class="token punctuation">,</span>
              start<span class="token operator">:</span> <span class="token number">11</span><span class="token punctuation">,</span>
              end<span class="token operator">:</span> <span class="token number">45</span><span class="token punctuation">,</span>
              loc<span class="token operator">:</span> <span class="token punctuation">{</span>
                start<span class="token operator">:</span> <span class="token punctuation">{</span> line<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> column<span class="token operator">:</span> <span class="token number">11</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
                end<span class="token operator">:</span> <span class="token punctuation">{</span> line<span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span> column<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span>
              <span class="token punctuation">}</span><span class="token punctuation">,</span>
              id<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
              generator<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
              async<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
              params<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
              body<span class="token operator">:</span> <span class="token punctuation">{</span>
                type<span class="token operator">:</span> <span class="token string">&quot;BlockStatement&quot;</span><span class="token punctuation">,</span>
                start<span class="token operator">:</span> <span class="token number">17</span><span class="token punctuation">,</span>
                end<span class="token operator">:</span> <span class="token number">45</span><span class="token punctuation">,</span>
                loc<span class="token operator">:</span> <span class="token punctuation">{</span>
                  start<span class="token operator">:</span> <span class="token punctuation">{</span> line<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> column<span class="token operator">:</span> <span class="token number">17</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
                  end<span class="token operator">:</span> <span class="token punctuation">{</span> line<span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span> column<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                body<span class="token operator">:</span> <span class="token punctuation">[</span>
                  <span class="token punctuation">{</span>
                    type<span class="token operator">:</span> <span class="token string">&quot;ExpressionStatement&quot;</span><span class="token punctuation">,</span>
                    start<span class="token operator">:</span> <span class="token number">21</span><span class="token punctuation">,</span>
                    end<span class="token operator">:</span> <span class="token number">43</span><span class="token punctuation">,</span>
                    loc<span class="token operator">:</span> <span class="token punctuation">{</span>
                      start<span class="token operator">:</span> <span class="token punctuation">{</span> line<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span> column<span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
                      end<span class="token operator">:</span> <span class="token punctuation">{</span> line<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span> column<span class="token operator">:</span> <span class="token number">24</span> <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
                    expression<span class="token operator">:</span> <span class="token punctuation">{</span>
                      type<span class="token operator">:</span> <span class="token string">&quot;CallExpression&quot;</span><span class="token punctuation">,</span>
                      start<span class="token operator">:</span> <span class="token number">21</span><span class="token punctuation">,</span>
                      end<span class="token operator">:</span> <span class="token number">43</span><span class="token punctuation">,</span>
                      loc<span class="token operator">:</span> <span class="token punctuation">{</span>
                        start<span class="token operator">:</span> <span class="token punctuation">{</span> line<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span> column<span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
                        end<span class="token operator">:</span> <span class="token punctuation">{</span> line<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span> column<span class="token operator">:</span> <span class="token number">24</span> <span class="token punctuation">}</span>
                      <span class="token punctuation">}</span><span class="token punctuation">,</span>
                      callee<span class="token operator">:</span> <span class="token punctuation">{</span>
                        type<span class="token operator">:</span> <span class="token string">&quot;MemberExpression&quot;</span><span class="token punctuation">,</span>
                        start<span class="token operator">:</span> <span class="token number">21</span><span class="token punctuation">,</span>
                        end<span class="token operator">:</span> <span class="token number">32</span><span class="token punctuation">,</span>
                        loc<span class="token operator">:</span> <span class="token punctuation">{</span>
                          start<span class="token operator">:</span> <span class="token punctuation">{</span> line<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span> column<span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
                          end<span class="token operator">:</span> <span class="token punctuation">{</span> line<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span> column<span class="token operator">:</span> <span class="token number">13</span> <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span><span class="token punctuation">,</span>
                        object<span class="token operator">:</span> <span class="token punctuation">{</span>
                          type<span class="token operator">:</span> <span class="token string">&quot;Identifier&quot;</span><span class="token punctuation">,</span>
                          start<span class="token operator">:</span> <span class="token number">21</span><span class="token punctuation">,</span>
                          end<span class="token operator">:</span> <span class="token number">28</span><span class="token punctuation">,</span>
                          loc<span class="token operator">:</span> <span class="token punctuation">{</span>
                            start<span class="token operator">:</span> <span class="token punctuation">{</span> line<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span> column<span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
                            end<span class="token operator">:</span> <span class="token punctuation">{</span> line<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span> column<span class="token operator">:</span> <span class="token number">9</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
                            identifierName<span class="token operator">:</span> <span class="token string">&quot;console&quot;</span>
                          <span class="token punctuation">}</span><span class="token punctuation">,</span>
                          name<span class="token operator">:</span> <span class="token string">&quot;console&quot;</span>
                        <span class="token punctuation">}</span><span class="token punctuation">,</span>
                        computed<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                        property<span class="token operator">:</span> <span class="token punctuation">{</span>
                          type<span class="token operator">:</span> <span class="token string">&quot;Identifier&quot;</span><span class="token punctuation">,</span>
                          start<span class="token operator">:</span> <span class="token number">29</span><span class="token punctuation">,</span>
                          end<span class="token operator">:</span> <span class="token number">32</span><span class="token punctuation">,</span>
                          loc<span class="token operator">:</span> <span class="token punctuation">{</span>
                            start<span class="token operator">:</span> <span class="token punctuation">{</span> line<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span> column<span class="token operator">:</span> <span class="token number">10</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
                            end<span class="token operator">:</span> <span class="token punctuation">{</span> line<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span> column<span class="token operator">:</span> <span class="token number">13</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
                            identifierName<span class="token operator">:</span> <span class="token string">&quot;log&quot;</span>
                          <span class="token punctuation">}</span><span class="token punctuation">,</span>
                          name<span class="token operator">:</span> <span class="token string">&quot;log&quot;</span>
                        <span class="token punctuation">}</span>
                      <span class="token punctuation">}</span><span class="token punctuation">,</span>
                      arguments<span class="token operator">:</span> <span class="token punctuation">[</span>
                        <span class="token punctuation">{</span>
                          type<span class="token operator">:</span> <span class="token string">&quot;StringLiteral&quot;</span><span class="token punctuation">,</span>
                          start<span class="token operator">:</span> <span class="token number">33</span><span class="token punctuation">,</span>
                          end<span class="token operator">:</span> <span class="token number">42</span><span class="token punctuation">,</span>
                          loc<span class="token operator">:</span> <span class="token punctuation">{</span>
                            start<span class="token operator">:</span> <span class="token punctuation">{</span> line<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span> column<span class="token operator">:</span> <span class="token number">14</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
                            end<span class="token operator">:</span> <span class="token punctuation">{</span> line<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span> column<span class="token operator">:</span> <span class="token number">23</span> <span class="token punctuation">}</span>
                          <span class="token punctuation">}</span><span class="token punctuation">,</span>
                          extra<span class="token operator">:</span> <span class="token punctuation">{</span> rawValue<span class="token operator">:</span> <span class="token string">&quot;welcome&quot;</span><span class="token punctuation">,</span> raw<span class="token operator">:</span> <span class="token string">&quot;'welcome'&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
                          value<span class="token operator">:</span> <span class="token string">&quot;welcome&quot;</span>
                        <span class="token punctuation">}</span>
                      <span class="token punctuation">]</span>
                    <span class="token punctuation">}</span>
                  <span class="token punctuation">}</span>
                <span class="token punctuation">]</span><span class="token punctuation">,</span>
                directives<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
              <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span>
              type<span class="token operator">:</span> <span class="token string">&quot;NumericLiteral&quot;</span><span class="token punctuation">,</span>
              start<span class="token operator">:</span> <span class="token number">47</span><span class="token punctuation">,</span>
              end<span class="token operator">:</span> <span class="token number">51</span><span class="token punctuation">,</span>
              loc<span class="token operator">:</span> <span class="token punctuation">{</span>
                start<span class="token operator">:</span> <span class="token punctuation">{</span> line<span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span> column<span class="token operator">:</span> <span class="token number">3</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
                end<span class="token operator">:</span> <span class="token punctuation">{</span> line<span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span> column<span class="token operator">:</span> <span class="token number">7</span> <span class="token punctuation">}</span>
              <span class="token punctuation">}</span><span class="token punctuation">,</span>
              extra<span class="token operator">:</span> <span class="token punctuation">{</span> rawValue<span class="token operator">:</span> <span class="token number">3000</span><span class="token punctuation">,</span> raw<span class="token operator">:</span> <span class="token string">&quot;3000&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
              value<span class="token operator">:</span> <span class="token number">3000</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    directives<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  comments<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br></div></div><p>简单的一个<code>setTimeout</code>，但对应的<code>AST</code>却相当复杂，毕竟需要准确描述出各个单元的位置，类型，具体内容等信息。简化结构如下</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">{</span>
  type<span class="token operator">:</span> <span class="token string">&quot;ExpressionStatement&quot;</span><span class="token punctuation">,</span>
  expression<span class="token operator">:</span> <span class="token punctuation">{</span>
    type<span class="token operator">:</span> <span class="token string">&quot;CallExpression&quot;</span><span class="token punctuation">,</span>
    callee<span class="token operator">:</span> <span class="token punctuation">{</span>
      type<span class="token operator">:</span> <span class="token string">&quot;Identifier&quot;</span><span class="token punctuation">,</span>
      name<span class="token operator">:</span> <span class="token string">&quot;setTimeout&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    arguments<span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        type<span class="token operator">:</span> <span class="token string">&quot;ArrowFunctionExpression&quot;</span><span class="token punctuation">,</span>
        body<span class="token operator">:</span> <span class="token punctuation">{</span>
          type<span class="token operator">:</span> <span class="token string">&quot;BlockStatement&quot;</span><span class="token punctuation">,</span>
          body<span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{</span>
              type<span class="token operator">:</span> <span class="token string">&quot;ExpressionStatement&quot;</span><span class="token punctuation">,</span>
              expression<span class="token operator">:</span> <span class="token punctuation">{</span>
                type<span class="token operator">:</span> <span class="token string">&quot;CallExpression&quot;</span><span class="token punctuation">,</span>
                callee<span class="token operator">:</span> <span class="token punctuation">{</span>
                  type<span class="token operator">:</span> <span class="token string">&quot;MemberExpression&quot;</span><span class="token punctuation">,</span>
                  object<span class="token operator">:</span> <span class="token punctuation">{</span>
                    type<span class="token operator">:</span> <span class="token string">&quot;Identifier&quot;</span><span class="token punctuation">,</span>
                    name<span class="token operator">:</span> <span class="token string">&quot;console&quot;</span>
                  <span class="token punctuation">}</span><span class="token punctuation">,</span>
                  computed<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                  property<span class="token operator">:</span> <span class="token punctuation">{</span>
                    type<span class="token operator">:</span> <span class="token string">&quot;Identifier&quot;</span><span class="token punctuation">,</span>
                    name<span class="token operator">:</span> <span class="token string">&quot;log&quot;</span>
                  <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                arguments<span class="token operator">:</span> <span class="token punctuation">[</span>
                  <span class="token punctuation">{</span>
                    type<span class="token operator">:</span> <span class="token string">&quot;StringLiteral&quot;</span><span class="token punctuation">,</span>
                    extra<span class="token operator">:</span> <span class="token punctuation">{</span> rawValue<span class="token operator">:</span> <span class="token string">&quot;welcome&quot;</span><span class="token punctuation">,</span> raw<span class="token operator">:</span> <span class="token string">&quot;'welcome'&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
                    value<span class="token operator">:</span> <span class="token string">&quot;welcome&quot;</span>
                  <span class="token punctuation">}</span>
                <span class="token punctuation">]</span>
              <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">]</span><span class="token punctuation">,</span>
          directives<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        type<span class="token operator">:</span> <span class="token string">&quot;NumericLiteral&quot;</span><span class="token punctuation">,</span>
        extra<span class="token operator">:</span> <span class="token punctuation">{</span> rawValue<span class="token operator">:</span> <span class="token number">3000</span><span class="token punctuation">,</span> raw<span class="token operator">:</span> <span class="token string">&quot;3000&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        value<span class="token operator">:</span> <span class="token number">3000</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br></div></div><p>仍旧不简单，但是已经能够较为清晰地看出一些逻辑。每个节点都有<code>type</code>，不同的类型，有相应的其他属性描述节点的具体内容。这里涉及的类型如下</p> <table><thead><tr><th>type</th> <th>意义</th> <th>出现次数</th></tr></thead> <tbody><tr><td>ExpressionStatement</td> <td>表达式</td> <td>2</td></tr> <tr><td>CallExpression</td> <td>调用表达式</td> <td>2</td></tr> <tr><td>ArrowFunctionExpression</td> <td>箭头函数</td> <td>1</td></tr> <tr><td>BlockStatement</td> <td>块声明</td> <td>1</td></tr> <tr><td>MemberExpression</td> <td>成员表达式</td> <td>1</td></tr> <tr><td>Identifier</td> <td>标识符</td> <td>3</td></tr> <tr><td>StringLiteral</td> <td>字符串字面量</td> <td>1</td></tr> <tr><td>NumericLiteral</td> <td>数字字面量</td> <td>1</td></tr></tbody></table> <p>那么解析出来不同的节点之后，在后面就可以根据<code>type</code>进行转换，比如说识别出<code>ArrowFunctionExpression</code>，那就可以做相应的函数降级转换。</p> <h2 id="transform"><a href="#transform" class="header-anchor">#</a> transform</h2> <p>就是对AST进行遍历优化，在这个过程中会遍历AST进行处理。首先来看一下前面例子</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> code <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">setTimeout(() =&gt; {
  console.log('welcome')
}, 3000)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;@babel/core&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">transformAsync</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>在源码的转换函数中添加以下代码</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> parsedAstString <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span>ast<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">yield</span><span class="token operator">*</span> <span class="token function">transformFile</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> config<span class="token punctuation">.</span>passes<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> transformedAstString <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span>ast<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>parsedAstString <span class="token operator">===</span> transformedAstString<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><strong>转换前后的<code>AST</code>完全一样</strong>，此事看起来有点蹊跷，其实原因也很明显，压根没有配置<code>preset</code>或者<code>plugins</code>，没给出任何转换的指示。接下来我们来详细看一下转换具体过程，看看<code>preset</code>和<code>plugins</code>是如何生效的。</p> <p>转换过程的核心函数 transformFile 如下</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">transformFile</span><span class="token punctuation">(</span>file<span class="token operator">:</span> File<span class="token punctuation">,</span> pluginPasses<span class="token operator">:</span> PluginPasses<span class="token punctuation">)</span><span class="token operator">:</span> Handler<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> pluginPairs <span class="token keyword">of</span> pluginPasses<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> passPairs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> passes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> visitors <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> plugin <span class="token keyword">of</span> pluginPairs<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token function">loadBlockHoistPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> pass <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PluginPass</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> plugin<span class="token punctuation">.</span>key<span class="token punctuation">,</span> plugin<span class="token punctuation">.</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>

      passPairs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">[</span>plugin<span class="token punctuation">,</span> pass<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      passes<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>pass<span class="token punctuation">)</span><span class="token punctuation">;</span>
      visitors<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>plugin<span class="token punctuation">.</span>visitor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token punctuation">[</span>plugin<span class="token punctuation">,</span> pass<span class="token punctuation">]</span> <span class="token keyword">of</span> passPairs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> fn <span class="token operator">=</span> plugin<span class="token punctuation">.</span>pre<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>fn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">fn</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>pass<span class="token punctuation">,</span> file<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// ...</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// merge all plugin visitors into a single visitor</span>
    <span class="token keyword">const</span> visitor <span class="token operator">=</span> traverse<span class="token punctuation">.</span>visitors<span class="token punctuation">.</span><span class="token function">merge</span><span class="token punctuation">(</span>
      visitors<span class="token punctuation">,</span>
      passes<span class="token punctuation">,</span>
      file<span class="token punctuation">.</span>opts<span class="token punctuation">.</span>wrapPluginVisitorMethod<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">traverse</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span>ast<span class="token punctuation">,</span> visitor<span class="token punctuation">,</span> file<span class="token punctuation">.</span>scope<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token punctuation">[</span>plugin<span class="token punctuation">,</span> pass<span class="token punctuation">]</span> <span class="token keyword">of</span> passPairs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> fn <span class="token operator">=</span> plugin<span class="token punctuation">.</span>post<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>fn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">fn</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>pass<span class="token punctuation">,</span> file<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// ...</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br></div></div><p>代码是很清晰的，前后是<code>plugin.pre</code>和<code>plugin.post</code>钩子函数的调用，中间主体是调用<code>traverse</code>函数来遍历。
这里涉及到了<code>traverse</code>和<code>visitor</code>这两个内容，后面单独小节进行讲解。</p> <h3 id="traverse"><a href="#traverse" class="header-anchor">#</a> traverse</h3> <p><code>traverse</code> 在 <code>@babel/traverse</code>模块，其基本语法为<code>traverse(ast, visitor)</code>(不完全准确，不影响理解)，示例如下</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> traverse <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;@babel/traverse&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>default<span class="token punctuation">;</span>
<span class="token keyword">const</span> parser <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;@babel/parser&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> code <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">setTimeout(() =&gt; {
  console.log('welcome')
}, 3000)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>

<span class="token keyword">const</span> ast <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">traverse</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function">enter</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">isIdentifier</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">&quot;setTimeout&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'enter setTimeout'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>traverse 就是用来做 AST 遍历的。这里请关注第二个参数 <code>visitor</code>，visitor 负责挂载节点访问相关的钩子函数，<code>enter</code>是一个通用的的访问钩子。还可以根据节点的类型设置</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">traverse</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function">Identifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Called!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>这段代码就表示，在节点类型为 <code>Identifier</code> 时执行对应的函数。</p> <p>traverse 负责遍历，而 visitor 就像是处理函数，负责添加钩子进行处理，于是在访问节点的时候，可以在钩子中去做节点的跳过，删除和替换等操作。</p> <h3 id="visitor"><a href="#visitor" class="header-anchor">#</a> visitor</h3> <p><code>Visitor</code>译为访问者，就是一个对象，描述了进入(或曰访问)或离开一个AST节点时要做什么。通过下方示例说明</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 每次进入一个 Identifier 节点做什么</span>
<span class="token keyword">const</span> myVisitor <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">Identifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Called!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token function">traverse</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> myVisitor<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>以上添加了<code>Identifier</code>节点访问钩子。在另一种配置方法里面，访问者有两个钩子<code>enter</code>和<code>exit</code></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> myVisitor <span class="token operator">=</span> <span class="token punctuation">{</span>
  BlockStatement<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token function">enter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Entered&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Exited&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string">'Identifier|ArrowFunctionExpression'</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token function">traverse</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> myVisitor<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>以上代码中，添加了<code>BlockStatement</code>类型节点访问和退出时的钩子函数，<code>exit</code>是在子树遍历完成向上返回到这个节点的时候执行，类似于事件的捕获和冒泡流程。</p> <h3 id="path"><a href="#path" class="header-anchor">#</a> path</h3> <p><code>path</code> 既是节点描述对象，同时也是结点操作工具，包含了节点描述，节点判断方法，节点操作方法等。示意如下</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> MyVisitor <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">BlockStatement</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 节点描述</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// BlockStatement</span>

    <span class="token comment">// 类型判断方法</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">isBlockStatement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// true</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">isIdentifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// false</span>

    <span class="token comment">// 操作方法</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> path<span class="token punctuation">.</span>remove<span class="token punctuation">)</span> <span class="token comment">// 'function'</span>
    path<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token function">traverse</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> MyVisitor<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>以上，分别展示了 path 对象的几类属性。</p> <h3 id="对比"><a href="#对比" class="header-anchor">#</a> 对比</h3> <p>当我们未指定任何<code>preset</code>或者<code>plugin</code>的时候，转换函数执行前后的AST完全一样，也就是转换函数对AST啥也没干，现在添加一个插件来看一下</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> code <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">setTimeout(() =&gt; {
  console.log('welcome')
}, 3000)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;@babel/core&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">transformAsync</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  plugins<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">&quot;@babel/plugin-transform-arrow-functions&quot;</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>在这个例子中，添加了一个箭头函数处理插件，AST 对比结果如下</p> <div class="language-txt line-numbers-mode"><pre class="language-text"><code>&lt; type: &quot;ArrowFunctionExpression&quot;,
---
&gt; type: &quot;FunctionExpression&quot;,
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><code>ArrowFunctionExpression</code>节点类型被转换为了<code>FunctionExpression</code>，则后续在代码生成时，就可以用<code>function</code>替换掉<code>=&gt;</code>了。</p> <p>通过这个插件<code>plugin-transform-arrow-functions</code>可以直观感受到插件在转换过程中的作用，具体关于插件的实现，插件与<code>visitor</code>的关系等，在后面通过单独的小节进行说明。</p> <h3 id="小结"><a href="#小结" class="header-anchor">#</a> 小结</h3> <p>traverse，visitor 和 path 这三部分的内容，可以与 switch 进行一个对比理解</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>ast<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">node</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token string">'BlockStatement'</span><span class="token operator">:</span>
      <span class="token comment">// ...</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token string">'Identifier'</span><span class="token operator">:</span>
    <span class="token keyword">case</span> <span class="token string">'ArrowFunctionExpression'</span><span class="token operator">:</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>traverse 就类似于这个 forEach 遍历，而 visitor 是这个 switch，具体的每个 case 怎么去做，就由 path 提供的操作方法组合使用。</p> <h2 id="generate"><a href="#generate" class="header-anchor">#</a> generate</h2> <p>代码生成，就是根据转换后的AST，去还原出兼容的代码，相关的包是<code>@babel/generator</code></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Generator</span> <span class="token keyword">extends</span> <span class="token class-name">Printer</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token function">generate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">generate</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>ast<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>而<code>Printer</code>如下</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Printer</span> <span class="token punctuation">{</span>
  declare _buf<span class="token operator">:</span> Buffer<span class="token punctuation">;</span>

  <span class="token comment">// ...</span>
  <span class="token function">generate</span><span class="token punctuation">(</span><span class="token parameter">ast</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span>ast<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_maybeAddAuxComment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_buf<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">print</span><span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span> parent<span class="token operator">?</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p><code>_buf</code>用来存储已转换部分的结果，实际转换的地方，就在<code>print</code>函数。用以下一个简单的<code>code</code>例子来看一下，是如何还原的</p> <div class="language-js line-numbers-mode"><div class="highlight-lines"><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br></div><pre class="language-js"><code><span class="token keyword">const</span> parser <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/parser'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> babel <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/core'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> code <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">() =&gt; {}</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="token keyword">const</span> ast <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> result <span class="token operator">=</span> babel<span class="token punctuation">.</span><span class="token function">transformFromAst</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> code<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  plugins<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">&quot;@babel/plugin-transform-arrow-functions&quot;</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>此时转换后的AST主体部分如下</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">{</span>
  type<span class="token operator">:</span> <span class="token string">&quot;ExpressionStatement&quot;</span><span class="token punctuation">,</span>
  start<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  end<span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">,</span>
  loc<span class="token operator">:</span> <span class="token punctuation">{</span> start<span class="token operator">:</span> <span class="token punctuation">{</span> line<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> column<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> end<span class="token operator">:</span> <span class="token punctuation">{</span> line<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> column<span class="token operator">:</span> <span class="token number">8</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  expression<span class="token operator">:</span> <span class="token punctuation">{</span>
    type<span class="token operator">:</span> <span class="token string">&quot;FunctionExpression&quot;</span><span class="token punctuation">,</span>
    start<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    end<span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">,</span>
    loc<span class="token operator">:</span> <span class="token punctuation">{</span> start<span class="token operator">:</span> <span class="token punctuation">{</span> line<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> column<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> end<span class="token operator">:</span> <span class="token punctuation">{</span> line<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> column<span class="token operator">:</span> <span class="token number">8</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    id<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    generator<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    async<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    params<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    body<span class="token operator">:</span> <span class="token punctuation">{</span>
      type<span class="token operator">:</span> <span class="token string">&quot;BlockStatement&quot;</span><span class="token punctuation">,</span>
      start<span class="token operator">:</span> <span class="token number">6</span><span class="token punctuation">,</span>
      end<span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">,</span>
      loc<span class="token operator">:</span> <span class="token punctuation">{</span> start<span class="token operator">:</span> <span class="token punctuation">{</span> line<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> column<span class="token operator">:</span> <span class="token number">6</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> end<span class="token operator">:</span> <span class="token punctuation">{</span> line<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> column<span class="token operator">:</span> <span class="token number">8</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      body<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      directives<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>还原的过程，就是遍历这些节点，根据<code>type</code>去生成新的代码，代码如下</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">class</span> <span class="token class-name">Printer</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token function">print</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> parent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">const</span> printMethod <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">[</span>node<span class="token punctuation">.</span><span class="token keyword">type</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> loc <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">isProgram</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span> <span class="token operator">||</span> t<span class="token punctuation">.</span><span class="token function">isFile</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> node<span class="token punctuation">.</span>loc<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">withSource</span><span class="token punctuation">(</span><span class="token string">&quot;start&quot;</span><span class="token punctuation">,</span> loc<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">printMethod</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> node<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p><code>node.type</code>对应的转换方法在<code>Printer</code>的原型链上，其中<code>FunctionExpression</code>如下</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">FunctionExpression</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">this</span><span class="token operator">:</span> Printer<span class="token punctuation">,</span> node<span class="token operator">:</span> t<span class="token punctuation">.</span>FunctionExpression</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_functionHead</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">space</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>body<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">_functionHead</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">this</span><span class="token operator">:</span> Printer<span class="token punctuation">,</span> node<span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>async<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">word</span><span class="token punctuation">(</span><span class="token string">&quot;async&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">space</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">word</span><span class="token punctuation">(</span><span class="token string">&quot;function&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>generator<span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">token</span><span class="token punctuation">(</span><span class="token string">&quot;*&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">space</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>id<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_params</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_predicate</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p><code>_functionHead</code>用以添加函数相关关键字，<code>word</code>函数用以向<code>_buf</code>中添加已经确认部分对应的标识符，而<code>this._params(node)</code>对参数进行转换，<code>this.print(node.body, node)</code>继续向下处理主体部分。</p> <h2 id="plugin"><a href="#plugin" class="header-anchor">#</a> plugin</h2> <p>前面我们已经提到了，插件要介入到代码转换的过程，就应该是通过添加<code>visitor</code>的方式，去对节点进行操作。以插件<code>plugin-transform-arrow-functions</code>为例，源码如下</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token keyword">declare</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@babel/helper-plugin-utils&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token keyword">type</span> <span class="token class-name">NodePath</span> <span class="token keyword">from</span> <span class="token string">&quot;@babel/traverse&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">declare</span><span class="token punctuation">(</span><span class="token punctuation">(</span>api<span class="token punctuation">,</span> options<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  api<span class="token punctuation">.</span><span class="token function">assertVersion</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> noNewArrows <span class="token operator">=</span> api<span class="token punctuation">.</span><span class="token function">assumption</span><span class="token punctuation">(</span><span class="token string">&quot;noNewArrows&quot;</span><span class="token punctuation">)</span> <span class="token operator">??</span> <span class="token operator">!</span>options<span class="token punctuation">.</span>spec<span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">&quot;transform-arrow-functions&quot;</span><span class="token punctuation">,</span>

    visitor<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token function">ArrowFunctionExpression</span><span class="token punctuation">(</span>
        path<span class="token operator">:</span> NodePath<span class="token operator">&lt;</span>BabelNodeArrowFunctionExpression<span class="token operator">&gt;</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// In some conversion cases, it may have already been converted to a function while this callback</span>
        <span class="token comment">// was queued up.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>path<span class="token punctuation">.</span><span class="token function">isArrowFunctionExpression</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

        path<span class="token punctuation">.</span><span class="token function">arrowFunctionToExpression</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          <span class="token comment">// While other utils may be fine inserting other arrows to make more transforms possible,</span>
          <span class="token comment">// the arrow transform itself absolutely cannot insert new arrow functions.</span>
          allowInsertArrow<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
          noNewArrows<span class="token punctuation">,</span>

          <span class="token comment">// TODO(Babel 8): This is only needed for backward compat with @babel/traverse &lt;7.13.0</span>
          specCompliant<span class="token operator">:</span> <span class="token operator">!</span>noNewArrows<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p>与前面所料不差，插件正是通过添加<code>visitor</code>，根据<code>node.type</code>针对<code>ArrowFunctionExpression</code>类型，通过<code>path</code>提供的方法对<code>node</code>进行了更新。插件的逻辑都是类似的，通过 <code>visitor</code> 注册处理函数，具体的处理方法在<code>path</code>对象提供。</p> <h2 id="preset"><a href="#preset" class="header-anchor">#</a> preset</h2> <p>preset 顾名思义就是 “预设”，其实就是常用插件的集合，是一个常用套装。在 parse 之前，在 <strong>load config</strong> 环节，babel 就会对 <code>presets</code> 配置进行处理，生成对应的插件列表保存在 <code>config.passes</code> 数组中，然后在 transform 环节，遍历插件列表，整合插件的 visitor，执行 AST 的转换。</p> <p><code>@babel/preset-env</code>其实是如下插件列表</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>plugins<span class="token operator">:</span> <span class="token punctuation">[</span>
  <span class="token string">'proposal-numeric-separator'</span><span class="token punctuation">,</span>
  <span class="token string">'proposal-logical-assignment-operators'</span><span class="token punctuation">,</span>
  <span class="token string">'proposal-nullish-coalescing-operator'</span><span class="token punctuation">,</span>
  <span class="token string">'proposal-optional-chaining'</span><span class="token punctuation">,</span>
  <span class="token string">'proposal-json-strings'</span><span class="token punctuation">,</span>
  <span class="token string">'proposal-optional-catch-binding'</span><span class="token punctuation">,</span>
  <span class="token string">'transform-parameters'</span><span class="token punctuation">,</span>
  <span class="token string">'proposal-async-generator-functions'</span><span class="token punctuation">,</span>
  <span class="token string">'proposal-object-rest-spread'</span><span class="token punctuation">,</span>
  <span class="token string">'transform-dotall-regex'</span><span class="token punctuation">,</span>
  <span class="token string">'proposal-unicode-property-regex'</span><span class="token punctuation">,</span>
  <span class="token string">'transform-named-capturing-groups-regex'</span><span class="token punctuation">,</span>
  <span class="token string">'transform-async-to-generator'</span><span class="token punctuation">,</span>
  <span class="token string">'transform-exponentiation-operator'</span><span class="token punctuation">,</span>
  <span class="token string">'transform-template-literals'</span><span class="token punctuation">,</span>
  <span class="token string">'transform-literals'</span><span class="token punctuation">,</span>
  <span class="token string">'transform-function-name'</span><span class="token punctuation">,</span>
  <span class="token string">'transform-arrow-functions'</span><span class="token punctuation">,</span>
  <span class="token string">'transform-block-scoped-functions'</span><span class="token punctuation">,</span>
  <span class="token string">'transform-classes'</span><span class="token punctuation">,</span>
  <span class="token string">'transform-object-super'</span><span class="token punctuation">,</span>
  <span class="token string">'transform-shorthand-properties'</span><span class="token punctuation">,</span>
  <span class="token string">'transform-duplicate-keys'</span><span class="token punctuation">,</span>
  <span class="token string">'transform-computed-properties'</span><span class="token punctuation">,</span>
  <span class="token string">'transform-for-of'</span><span class="token punctuation">,</span>
  <span class="token string">'transform-sticky-regex'</span><span class="token punctuation">,</span>
  <span class="token string">'transform-unicode-escapes'</span><span class="token punctuation">,</span>
  <span class="token string">'transform-unicode-regex'</span><span class="token punctuation">,</span>
  <span class="token string">'transform-spread'</span><span class="token punctuation">,</span>
  <span class="token string">'transform-destructuring'</span><span class="token punctuation">,</span>
  <span class="token string">'transform-block-scoping'</span><span class="token punctuation">,</span>
  <span class="token string">'transform-typeof-symbol'</span><span class="token punctuation">,</span>
  <span class="token string">'transform-new-target'</span><span class="token punctuation">,</span>
  <span class="token string">'regenerator-transform'</span><span class="token punctuation">,</span>
  <span class="token string">'transform-member-expression-literals'</span><span class="token punctuation">,</span>
  <span class="token string">'transform-property-literals'</span><span class="token punctuation">,</span>
  <span class="token string">'transform-reserved-words'</span><span class="token punctuation">,</span>
  <span class="token string">'proposal-export-namespace-from'</span><span class="token punctuation">,</span>
  <span class="token string">'transform-modules-commonjs'</span><span class="token punctuation">,</span>
  <span class="token string">'proposal-dynamic-import'</span>
<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br></div></div><h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p><code>babel</code>转码分成三个步骤</p> <ul><li>parse：生成AST</li> <li>transform：根据提供的插件去对节点进行处理转化，这一步完成了 AST 层面兼容，节点的<code>type</code>转换为对应的兼容类型，
<ul><li>traverse：迭代节点</li> <li>visitor：注册节点转换处理函数</li> <li>path：提供节点操作方法</li></ul></li> <li>generate：根据<code>node.type</code>去调用预定义好的各种类型节点的生成函数，生成新的代码。</li></ul> <p>先解析成 AST，然后根据配置的插件和 presets 进行转换，最终再根据 AST 生成转换后的代码。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/docs/manual/engineering/" class="prev router-link-active">
        工程化
      </a></span> <span class="next"><a href="/docs/manual/engineering/wp.html">
        Webpack
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><div tabindex="-1" role="dialog" aria-hidden="true" class="pswp"><div class="pswp__bg"></div> <div class="pswp__scroll-wrap"><div class="pswp__container"><div class="pswp__item"></div> <div class="pswp__item"></div> <div class="pswp__item"></div></div> <div class="pswp__ui pswp__ui--hidden"><div class="pswp__top-bar"><div class="pswp__counter"></div> <button class="pswp__button pswp__button--close"></button> <button class="pswp__button pswp__button--share"></button> <button class="pswp__button pswp__button--fs"></button> <button class="pswp__button pswp__button--zoom"></button> <div class="pswp__preloader"><div class="pswp__preloader__icn"><div class="pswp__preloader__cut"><div class="pswp__preloader__donut"></div></div></div></div></div> <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class="pswp__share-tooltip"></div></div> <button class="pswp__button pswp__button--arrow--left"></button> <button class="pswp__button pswp__button--arrow--right"></button> <div class="pswp__caption"><div class="pswp__caption__center"></div></div></div></div></div></div></div>
    <script src="/docs/assets/js/app.a2920d1a.js" defer></script><script src="/docs/assets/js/3.2c08a1e7.js" defer></script><script src="/docs/assets/js/47.2ab3c263.js" defer></script>
  </body>
</html>
